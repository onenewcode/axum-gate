# GitLab CI configuration for axum-gate
# Runs comprehensive tests for all features and combinations

variables:
    CARGO_HOME: $CI_PROJECT_DIR/.cargo
    RUST_BACKTRACE: 1
    RUSTFLAGS: "-D warnings"

# Cache configuration
.cargo_cache: &cargo_cache
    cache:
        key:
            files:
                - Cargo.lock
        paths:
            - .cargo/
            - target/

stages:
    - check
    - test
    - security
    - examples

# Base job configuration
.rust_job: &rust_job
    image: rust:latest
    before_script:
        - rustc --version
        - cargo --version
        - rustup component add clippy rustfmt
    <<: *cargo_cache

# Check stage jobs
format_check:
    <<: *rust_job
    stage: check
    script:
        - cargo fmt --all -- --check
    allow_failure: false

clippy_check:
    <<: *rust_job
    stage: check
    script:
        - cargo clippy --workspace --all-targets -- -D warnings
        - cargo clippy --all-targets --no-default-features --features aws_lc_rs -- -D warnings
    allow_failure: false

# Test stage jobs - Core tests
test_no_features:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --no-default-features
    allow_failure: false

test_default_features:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace
    allow_failure: false

test_aws_lc_rs:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --no-default-features --features aws_lc_rs
    allow_failure: false

# Individual feature tests
test_insecure_fast_hash:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --no-default-features --features insecure-fast-hash
    allow_failure: false

test_storage_surrealdb:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --no-default-features --features storage-surrealdb
    allow_failure: false

test_storage_seaorm:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --no-default-features --features storage-seaorm
    allow_failure: false

# Feature combination tests
test_all_storage_features:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --no-default-features --features storage-surrealdb,storage-seaorm
    allow_failure: false

test_fast_hash_with_surrealdb:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --no-default-features --features insecure-fast-hash,storage-surrealdb
    allow_failure: false

test_fast_hash_with_seaorm:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --no-default-features --features insecure-fast-hash,storage-seaorm
    allow_failure: false

# Integration and doc tests
test_integration:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --test '*'
    allow_failure: false

test_doc:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --doc
    allow_failure: false

# Security stage jobs
cargo_audit:
    <<: *rust_job
    stage: security
    script:
        - cargo install cargo-audit
        - cargo audit --ignore RUSTSEC-2023-0071 --ignore RUSTSEC-2024-0436
    allow_failure: false

cargo_deny:
    <<: *rust_job
    stage: security
    script:
        - cargo install cargo-deny
        - cargo deny check
    allow_failure: false

cargo_semver_checks:
    <<: *rust_job
    stage: security
    script:
        - cargo install cargo-semver-checks
        - cargo semver-checks check-release
    allow_failure: false
    only:
        - merge_requests
        - nightly

# Example compilation and basic tests
examples_simple_usage:
    <<: *rust_job
    stage: examples
    script:
        - cargo check -p simple-usage-example
        - cargo test -p simple-usage-example
    allow_failure: false

examples_custom_roles:
    <<: *rust_job
    stage: examples
    script:
        - cargo check -p custom-roles-example
        - cargo test -p custom-roles-example
    allow_failure: false

examples_distributed:
    <<: *rust_job
    stage: examples
    script:
        - cargo check -p distributed
        - cargo test -p distributed
    allow_failure: false

examples_permission_validation:
    <<: *rust_job
    stage: examples
    script:
        - cargo check -p permission-validation-example
        - cargo test -p permission-validation-example
    allow_failure: false

examples_rate_limiting:
    <<: *rust_job
    stage: examples
    script:
        - cargo check -p rate-limiting-example
        - cargo test -p rate-limiting-example
    allow_failure: false

examples_sea_orm:
    <<: *rust_job
    stage: examples
    script:
        - cargo check -p sea-orm-example
        - cargo test -p sea-orm-example
    allow_failure: false

examples_surrealdb:
    <<: *rust_job
    stage: examples
    script:
        - cargo check -p surrealdb-example
        - cargo test -p surrealdb-example
    allow_failure: false

# Build verification for different Rust versions
test_msrv:
    image: rust:1.88
    stage: test
    script:
        - rustc --version
        - cargo check --workspace
        - cargo test --workspace
    allow_failure: false

test_stable:
    image: rust:latest
    stage: test
    script:
        - rustc --version
        - cargo check --workspace
        - cargo test --workspace
    allow_failure: true

# Performance and benchmark tests (if any)
bench_tests:
    <<: *rust_job
    stage: test
    script:
        - cargo test --workspace --benches
    allow_failure: true
    only:
        - nightly
        - merge_requests
# Coverage report (optional)
# Currently disabled because of specific security features in docker are not disabled
# coverage:
#     <<: *rust_job
#     stage: test
#     script:
#         - cargo install cargo-tarpaulin
#         - cargo tarpaulin --workspace --out Markdown
#     coverage: '/(\d+\.\d+)% coverage/'
#     artifacts:
#         paths:
#             - tarpaulin-report.md
#     allow_failure: true
#     only:
#         - nightly
